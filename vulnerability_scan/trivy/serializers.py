from django.core import serializers
import json
from .models import TrivyConfig


def create_trivy_image_config_entry_in_db(scan_details):
    try:
        TrivyConfig.objects.create(   
            image_uri=scan_details['details']["image_uri"],   
            organization=scan_details["organization"]
            )
    except Exception as e:
        print("Error creating vulnerablity_scan details in DB \n{}".format(e))

def get_trivy_image_details(organization=None,image_uri=None):
    """returns instnace details based on vulnerablity_scan if it exits in db 
    else return None 
    """
    try:
        data = json.loads(serializers.serialize('json', TrivyConfig.objects.filter(
            organization=organization, image_uri=image_uri),
            fields=(
                "image_scan",
                "organization",
                "returncode",
                "image_uri",
                "statuscode",
                "message"
                )
            )
        )
        if len(data) !=0:
            for trivy_obj in data:

                if trivy_obj["fields"]["organization"] == organization :
                    temp_dict_obj=trivy_obj["fields"]
                    return  temp_dict_obj
        return {}
    except Exception as e:
        print("Exception--> {}".format(e))
        return {}

def update_trivy_image_details(scan_details):
    try:
        if len(scan_details) != 0:
            TrivyConfig.objects.filter(organization=scan_details["organization"], image_uri= scan_details["image_uri"]).update(**scan_details)
    except Exception as e:
        print("Error updating instance details \n{}".format(e))